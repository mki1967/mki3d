/* mki3d */

mki3d={};

/* default data */
mki3d.data=mki3d.defaultData= {"model":{"segments":[[{"position":[2,0,0],"color":[1,1,1],"set":0},{"position":[4,-2,0],"color":[1,1,1],"set":0}],[{"position":[2,0,0],"color":[1,1,1],"set":0},{"position":[4,2,0],"color":[1,1,1],"set":0}],[{"position":[4,-2,0],"color":[1,1,1],"set":0},{"position":[4,-1,0],"color":[1,1,1],"set":0}],[{"position":[4,-1,0],"color":[1,1,1],"set":0},{"position":[8,-1,0],"color":[1,1,1],"set":0}],[{"position":[4,1,0],"color":[1,1,1],"set":0},{"position":[4,2,0],"color":[1,1,1],"set":0}],[{"position":[4,1,0],"color":[1,1,1],"set":0},{"position":[8,1,0],"color":[1,1,1],"set":0}],[{"position":[8,-1,0],"color":[1,1,1],"set":0},{"position":[8,1,0],"color":[1,1,1],"set":0}],[{"position":[0,3,0],"color":[1,1,1],"set":1},{"position":[-1,3,0],"color":[1,1,1],"set":1}],[{"position":[0,3,0],"color":[1,1,1],"set":1},{"position":[0,7,0],"color":[1,1,1],"set":1}],[{"position":[1,1,0],"color":[1,1,1],"set":1},{"position":[-1,3,0],"color":[1,1,1],"set":1}],[{"position":[1,1,0],"color":[1,1,1],"set":1},{"position":[3,3,0],"color":[1,1,1],"set":1}],[{"position":[2,3,0],"color":[1,1,1],"set":1},{"position":[2,7,0],"color":[1,1,1],"set":1}],[{"position":[2,7,0],"color":[1,1,1],"set":1},{"position":[0,7,0],"color":[1,1,1],"set":1}],[{"position":[3,3,0],"color":[1,1,1],"set":1},{"position":[2,3,0],"color":[1,1,1],"set":1}],[{"position":[-6,1,0],"color":[1,1,1],"set":2},{"position":[-6,-1,0],"color":[1,1,1],"set":2}],[{"position":[-2,-1,0],"color":[1,1,1],"set":2},{"position":[-6,-1,0],"color":[1,1,1],"set":2}],[{"position":[-2,-1,0],"color":[1,1,1],"set":2},{"position":[-2,-2,0],"color":[1,1,1],"set":2}],[{"position":[-2,1,0],"color":[1,1,1],"set":2},{"position":[-6,1,0],"color":[1,1,1],"set":2}],[{"position":[-2,2,0],"color":[1,1,1],"set":2},{"position":[-2,1,0],"color":[1,1,1],"set":2}],[{"position":[0,0,0],"color":[1,1,1],"set":2},{"position":[-2,-2,0],"color":[1,1,1],"set":2}],[{"position":[0,0,0],"color":[1,1,1],"set":2},{"position":[-2,2,0],"color":[1,1,1],"set":2}],[{"position":[-1,-3,0],"color":[1,1,1],"set":3},{"position":[0,-3,0],"color":[1,1,1],"set":3}],[{"position":[0,-7,0],"color":[1,1,1],"set":3},{"position":[2,-7,0],"color":[1,1,1],"set":3}],[{"position":[0,-3,0],"color":[1,1,1],"set":3},{"position":[0,-7,0],"color":[1,1,1],"set":3}],[{"position":[1,-1,0],"color":[1,1,1],"set":3},{"position":[-1,-3,0],"color":[1,1,1],"set":3}],[{"position":[1,-1,0],"color":[1,1,1],"set":3},{"position":[3,-3,0],"color":[1,1,1],"set":3}],[{"position":[2,-3,0],"color":[1,1,1],"set":3},{"position":[2,-7,0],"color":[1,1,1],"set":3}],[{"position":[2,-3,0],"color":[1,1,1],"set":3},{"position":[3,-3,0],"color":[1,1,1],"set":3}]],"triangles":[[{"position":[2,0,0],"color":[0,0,1],"set":0},{"position":[4,-2,0],"color":[0,0,1],"set":0},{"position":[4,2,0],"color":[0,0,1],"set":0}],[{"position":[4,-1,0],"color":[0,0,1],"set":0},{"position":[4,1,0],"color":[0,0,1],"set":0},{"position":[8,-1,0],"color":[0,0,1],"set":0}],[{"position":[4,1,0],"color":[0,0,1],"set":0},{"position":[8,-1,0],"color":[0,0,1],"set":0},{"position":[8,1,0],"color":[0,0,1],"set":0}],[{"position":[0,3,0],"color":[0,0,1],"set":1},{"position":[2,7,0],"color":[0,0,1],"set":1},{"position":[0,7,0],"color":[0,0,1],"set":1}],[{"position":[1,1,0],"color":[0,0,1],"set":1},{"position":[3,3,0],"color":[0,0,1],"set":1},{"position":[-1,3,0],"color":[0,0,1],"set":1}],[{"position":[2,3,0],"color":[0,0,1],"set":1},{"position":[0,3,0],"color":[0,0,1],"set":1},{"position":[2,7,0],"color":[0,0,1],"set":1}],[{"position":[-2,-1,0],"color":[0,0,1],"set":2},{"position":[-6,1,0],"color":[0,0,1],"set":2},{"position":[-6,-1,0],"color":[0,0,1],"set":2}],[{"position":[-2,1,0],"color":[0,0,1],"set":2},{"position":[-2,-1,0],"color":[0,0,1],"set":2},{"position":[-6,1,0],"color":[0,0,1],"set":2}],[{"position":[0,0,0],"color":[0,0,1],"set":2},{"position":[-2,2,0],"color":[0,0,1],"set":2},{"position":[-2,-2,0],"color":[0,0,1],"set":2}],[{"position":[0,-3,0],"color":[0,0,1],"set":3},{"position":[2,-3,0],"color":[0,0,1],"set":3},{"position":[0,-7,0],"color":[0,0,1],"set":3}],[{"position":[1,-1,0],"color":[0,0,1],"set":3},{"position":[-1,-3,0],"color":[0,0,1],"set":3},{"position":[3,-3,0],"color":[0,0,1],"set":3}],[{"position":[2,-3,0],"color":[0,0,1],"set":3},{"position":[0,-7,0],"color":[0,0,1],"set":3},{"position":[2,-7,0],"color":[0,0,1],"set":3}]]},"view":{"focusPoint":[1,0,0],"rotationMatrix":[[1,0,0],[0,1,0],[0,0,1]],"scale":1,"screenShift":[0,0,60]},"projection":{"zNear":0.25,"zFar":300,"zoomY":4},"backgroundColor":[0,0,0],"cursor":{"position":[1,0,-20],"marker1":null,"marker2":null,"color":[0,0,1],"step":1},"clipMaxVector":[100000000000000000000,100000000000000000000,100000000000000000000],"clipMinVector":[-100000000000000000000,-100000000000000000000,-100000000000000000000],"light":{"vector":[0,0,1],"ambientFraction":0.2},"set":{"current":3},"links":[{"label":"INDEX","opener":"","url":"travel-index.html","position":[1,0,0]}]}

mki3d.url={};

mki3d.url.base=document.referrer;

/* shape of the link symbol */
mki3d.url.symbol ={"model":{"segments":[[{"position":[-0.5,0,0],"color":[0,0,1],"set":0},{"position":[0,-0.5,0],"color":[0,0,1],"set":0}],[{"position":[-0.5,0,0],"color":[0,0,1],"set":0},{"position":[0,0.5,0],"color":[0,0,1],"set":0}],[{"position":[0,-0.5,0],"color":[0,0,1],"set":0},{"position":[0.5,0,0],"color":[0,0,1],"set":0}],[{"position":[0,0.5,0],"color":[0,0,1],"set":0},{"position":[0.5,0,0],"color":[0,0,1],"set":0}]],"triangles":[[{"position":[-0.5,0,0],"color":[1,1,1],"set":0},{"position":[0,-0.5,0],"color":[1,1,1],"set":0},{"position":[0,0,0],"color":[1,1,1],"set":0}],[{"position":[-0.5,0,0],"color":[1,0,0],"set":0},{"position":[0,0,0],"color":[1,0,0],"set":0},{"position":[0,0.5,0],"color":[1,0,0],"set":0}],[{"position":[0,-0.5,0],"color":[1,0,0],"set":0},{"position":[0,0,0],"color":[1,0,0],"set":0},{"position":[0.5,0,0],"color":[1,0,0],"set":0}],[{"position":[0,0,0],"color":[1,1,1],"set":0},{"position":[0,0.5,0],"color":[1,1,1],"set":0},{"position":[0.5,0,0],"color":[1,1,1],"set":0}]]},"view":{"focusPoint":[0,0,0],"rotationMatrix":[[1,0,0],[0,1,0],[0,0,1]],"scale":2,"screenShift":[0,0,60]},"projection":{"zNear":0.25,"zFar":300,"zoomY":4},"backgroundColor":[0,1,1],"cursor":{"position":[0,0,0],"marker1":null,"marker2":null,"color":[0,0,1],"step":0.5},"clipMaxVector":[100000000000000000000,100000000000000000000,100000000000000000000],"clipMinVector":[-100000000000000000000,-100000000000000000000,-100000000000000000000],"light":{"vector":[0,0,1],"ambientFraction":0.2},"set":{"current":0}}


mki3d.sectors={"model":{"segments":[[{"position":[-1,-1,0],"color":[1,0,0],"set":0},{"position":[-1,1,0],"color":[1,0,0],"set":0}],[{"position":[-1,-1,0],"color":[1,0,0],"set":0},{"position":[1,-1,0],"color":[1,0,0],"set":0}],[{"position":[-1,-0.3333333333333333,0],"color":[1,0,0],"set":0},{"position":[1,-0.3333333333333333,0],"color":[1,0,0],"set":0}],[{"position":[-1,0.3333333333333333,0],"color":[1,0,0],"set":0},{"position":[1,0.3333333333333333,0],"color":[1,0,0],"set":0}],[{"position":[-1,1,0],"color":[1,0,0],"set":0},{"position":[1,1,0],"color":[1,0,0],"set":0}],[{"position":[-0.6666666666666666,-0.3333333333333333,0],"color":[1,0,0],"set":0},{"position":[-0.6666666666666666,0.3333333333333333,0],"color":[1,0,0],"set":0}],[{"position":[-0.3333333333333333,-1,0],"color":[1,0,0],"set":0},{"position":[-0.3333333333333333,1,0],"color":[1,0,0],"set":0}],[{"position":[-0.3333333333333333,-0.6666666666666666,0],"color":[1,0,0],"set":0},{"position":[0.3333333333333333,-0.6666666666666666,0],"color":[1,0,0],"set":0}],[{"position":[-0.3333333333333333,0.6666666666666666,0],"color":[1,0,0],"set":0},{"position":[0.3333333333333333,0.6666666666666666,0],"color":[1,0,0],"set":0}],[{"position":[0.3333333333333333,-1,0],"color":[1,0,0],"set":0},{"position":[0.3333333333333333,1,0],"color":[1,0,0],"set":0}],[{"position":[0.6666666666666666,-0.3333333333333333,0],"color":[1,0,0],"set":0},{"position":[0.6666666666666666,0.3333333333333333,0],"color":[1,0,0],"set":0}],[{"position":[1,-1,0],"color":[1,0,0],"set":0},{"position":[1,1,0],"color":[1,0,0],"set":0}]],"triangles":[]},"view":{"focusPoint":[0,0,0],"rotationMatrix":[[1,0,0],[0,1,0],[0,0,1]],"scale":10,"screenShift":[0,0,60]},"projection":{"zNear":0.25,"zFar":300,"zoomY":4},"backgroundColor":[0,0,0],"cursor":{"position":[0,0,0],"marker1":null,"marker2":null,"color":[1,0,0],"step":0.1},"clipMaxVector":[100000000000000000000,100000000000000000000,100000000000000000000],"clipMinVector":[-100000000000000000000,-100000000000000000000,-100000000000000000000],"light":{"vector":[0,0,1],"ambientFraction":0.2},"set":{"current":0}}



mki3d.message= showMessage;

mki3d.url.load = async function( input ) { // load from url 
    // console.log(input); /// tests
    let backup= mki3d.data;
    let url;
    try{
	if( mki3d.url.base )
	    url=new URL(input, mki3d.url.base );
	else
	    url=new URL(input); 
	// console.log(url); /// tests
	mki3d.message("<div style='font-size:30px;'> LOADING FROM "+url+" ...</div>");
	let response=await fetch(url, {cache: 'no-cache', mode: 'cors'} );
	// console.log( response );   
	let result= await response.json();
	// console.log(result); /// tests	
	mki3d.data=result; /// !!!
	// let filename = url.substring(url.lastIndexOf('/')+1);
	let pathname = url.pathname;
	let filename = pathname.substring(pathname.lastIndexOf('/')+1);
	mki3d.url.base= url; // new base for next load
	mki3d.message("<div style='font-size:30px;'>LOADED FROM "+url+".</div>");
	console.log( mki3d.data ); /// test
    }
    catch( err ) {
	console.log(err);
	mki3d.message("<div style='font-size:30px;'>FAILED TO LOAD FROM "+url+".</div>");
	mki3d.data=mki3d.defaultData;
    }
    // console.log(mki3d.data); /// tests
}

mki3d.url.completeLink= function ( opener, input) {
    if(! input ) return null; // input must be!
    let url;
    if( mki3d.url.base )
	url=new URL(input, mki3d.url.base );
    else
	url=new URL(input);
    if( !opener ) return url;

    let openerURL= new URL(opener, window.location.href ); // if opener is relative URL we take the base of current window
    // add code for opener ...

    return String(openerURL)+encodeURI(String(url)); // the url as encoded parameter
}







/* handling mki3d data */

mki3dIndex={}

mki3dStage={}

mki3dToken={}

loadedStage={}

/* shadeFactor is computed for triangles */
/* Color of the triangle is scaled by the shade factor before placing it into buffer of colors */
/* light parameter can be mki3d.data.light  */
shadeFactor= function ( triangle, light) {
    var normal= normalToPlane(triangle[0].position,triangle[1].position,triangle[2].position);
    var sp= scalarProduct(light.vector, normal);
    return light.ambientFraction+(1-light.ambientFraction)*Math.abs(sp);  
}

/* load model to its GL buffer */
// TO DO ...
function makeGraph (mki3dData, light){
    const MKI3D_VERTEX_POSITION_SIZE=3
    var model = mki3dData.model;

    var graph ={}; // to be constructed and returned
    
    var elements = [];
    var elementsColors = [];


    var i,j;
    for(i=0; i<model.segments.length; i++){
	for(j=0; j<2; j++){
	    elements.push(model.segments[i][j].position[0]);
	    elements.push(model.segments[i][j].position[1]);
	    elements.push(model.segments[i][j].position[2]);

	    elementsColors.push(model.segments[i][j].color[0]);
	    elementsColors.push(model.segments[i][j].color[1]);
	    elementsColors.push(model.segments[i][j].color[2]);
	    
	}
    }


    graph.nrOfLines = elements.length/(2*MKI3D_VERTEX_POSITION_SIZE);
    graph.linesVertices = new Float32Array( elements );
    graph.linesColors = new Float32Array( elementsColors )
    
    // TO DO: triangles

    elements = [];
    elementsColors = [];

    
    for(i=0; i<model.triangles.length; i++){
	var triangle=model.triangles[i];
	if(!triangle.shade) 
	    triangle.shade = shadeFactor( triangle, light);
	for(j=0; j<3; j++){
	    elements.push(triangle[j].position[0]);
	    elements.push(triangle[j].position[1]);
	    elements.push(triangle[j].position[2]);

	    elementsColors.push(triangle[j].color[0]*triangle.shade);
	    elementsColors.push(triangle[j].color[1]*triangle.shade);
	    elementsColors.push(triangle[j].color[2]*triangle.shade);
	    
	}
    }

    /*
    // load triangles and colors to GL buffers

    gl.bindBuffer(gl.ARRAY_BUFFER, buf.triangles);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array( elements ), gl.DYNAMIC_DRAW );
    
    gl.bindBuffer(gl.ARRAY_BUFFER, buf.trianglesColors);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array( elementsColors ), gl.DYNAMIC_DRAW );

    buf.nrOfTriangles =  elements.length/(3*MKI3D_VERTEX_POSITION_SIZE); 
    */
    
    graph.nrOfTriangles = elements.length/(3*MKI3D_VERTEX_POSITION_SIZE);
    graph.trianglesVertices = new Float32Array( elements );
    graph.trianglesColors = new Float32Array( elementsColors )


    ////// 
    return graph;
}




// recompute bounding box  with the BoxMargin  corners of the stage.
function copmuteVMinVMax(mki3dData) {
    var VMax = vectorClone(mki3dData.cursor.position); // cursror position should be included - the starting poin of traveler
    var VMin = vectorClone(VMax);

    for (var s = 0; s< mki3dData.model.segments.length; s++) {
	var seg = mki3dData.model.segments[s];
	for (p= 0; p<seg.length; p++) {
	    var point = seg[p];
	    for (var d =0; d<point.position.length; d++) {
		if (VMax[d] < point.position[d]) {
		    VMax[d] = point.position[d];
		}
		if (VMin[d] > point.position[d]) {
		    VMin[d] = point.position[d];
		}
	    }
	    
	}
    }
    
    for (var t = 0; t< mki3dData.model.triangles.length; t++) {
	var tr = mki3dData.model.triangles[t]
	for(var p= 0; p<tr.length; p++){
	    var point = tr[p];
	    for (var d =0; d<point.position.length; d++) {
		if (VMax[d] < point.position[d]) {
		    VMax[d] = point.position[d];
		}
		if (VMin[d] > point.position[d]) {
		    VMin[d] = point.position[d];
		}
	    }
	    
	}
    }

    // url links ...
    if(! mki3d.data.links ) return [VMin, VMax];

    var i;
    for(i=0; i<mki3d.data.links.length; i++) {
	let position= mki3d.data.links[i].position;
	for (var d =0; d<position.length; d++) {
	    if (VMax[d] < position[d]) {
		VMax[d] = position[d];
	    }
	    if (VMin[d] > position[d]) {
		VMin[d] = position[d];
	    }
	}
    } 


    
    return [VMin, VMax];
}

// compute traveler
function makeTraveler(mki3dData) {
    var vbox =  copmuteVMinVMax(mki3dData) ;
    var traveler={}
    traveler.vMin= vbox[0];
    traveler.vMax= vbox[1];

    traveler.x = mki3dData.cursor.position[0]
    traveler.y = mki3dData.cursor.position[1]
    traveler.z = mki3dData.cursor.position[2]

    traveler.rotXZ= 0 ;
    traveler.rotYZ= 0 ;
    return traveler ;
}

function makeStage(mki3dData, mki3dToken) {
    var stage = {}
    stage.traveler = makeTraveler(mki3dData);
    stage.bgColor = mki3dData.backgroundColor;
    var light= mki3dData.light
    stage.scene = makeGraph (mki3dData, light) ////
    stage.token = makeGraph (mki3dToken, mki3dToken.light)  ////
    stage.frameBox= makeFrameBox(stage.traveler);


    return stage;
}


